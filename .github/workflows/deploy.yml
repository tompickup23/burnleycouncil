name: Build & Deploy Lancashire Councils

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'burnley-council/reports/**'
      - 'IMPROVEMENTS.md'
      - '.claude/**'
  workflow_dispatch:

concurrency:
  group: deploy-lancashire
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      COUNCILS: "burnley:burnleycouncil hyndburn:hyndburncouncil pendle:pendlecouncil rossendale:rossendalecouncil lancaster:lancastercouncil ribble_valley:ribblevalleycouncil chorley:chorleycouncil south_ribble:southribblecouncil lancashire_cc:lancashirecc blackpool:blackpoolcouncil west_lancashire:westlancashirecouncil blackburn:blackburncouncil wyre:wyrecouncil preston:prestoncouncil fylde:fyldecouncil lancashire_pcc:lancashirepcc lancashire_fire:lancashirefire"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Create deploy directory
        run: mkdir -p /tmp/lancashire-deploy

      # Spending chunk files are gitignored (too large for source repo).
      # Restore them from the previous deploy by cloning the deploy repo's gh-pages branch.
      # This is more robust than curling the CDN (avoids propagation delays, works offline).
      # v4 monthly chunks: LCC, Blackpool, Blackburn (~647MB total)
      # v3 year chunks: 12 district councils (~240MB total)
      # If chunks aren't found (first deploy), districts fall back to spending.json monolith.
      # v4 councils need a one-time bootstrap: scripts/push_spending_data.sh
      - name: Restore spending chunks from previous deploy
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          echo "Cloning deploy repo to restore spending data..."
          PREV_DEPLOY="/tmp/prev-deploy"
          if git clone --depth 1 --branch gh-pages \
            "https://x-access-token:${DEPLOY_TOKEN}@github.com/tompickup23/lancashire.git" \
            "$PREV_DEPLOY" 2>/dev/null; then
            echo "✓ Cloned previous deploy"
          else
            echo "⚠ No previous deploy found (first deploy?) — skipping chunk restore"
            exit 0
          fi

          # --- v4 monthly councils ---
          V4_COUNCILS="lancashire_cc:lancashirecc blackpool:blackpoolcouncil blackburn:blackburncouncil"
          V4_RESTORED=0
          for entry in $V4_COUNCILS; do
            COUNCIL_ID="${entry%%:*}"
            SLUG="${entry##*:}"
            DEST="burnley-council/data/${COUNCIL_ID}"
            SRC="${PREV_DEPLOY}/${SLUG}/data"
            if [ -f "${SRC}/spending-index.json" ]; then
              # Copy index
              cp "${SRC}/spending-index.json" "${DEST}/spending-index.json"
              # Copy all monthly chunk files (spending-YYYY-MM.json where MM is 01-12)
              COUNT=0
              for f in "${SRC}"/spending-20??-??.json; do
                [ -f "$f" ] || continue
                BASE=$(basename "$f")
                SUFFIX=$(echo "$BASE" | sed 's/.*-\([0-9][0-9]\)\.json/\1/')
                if [ "$SUFFIX" -le 12 ] 2>/dev/null; then
                  cp "$f" "${DEST}/${BASE}"
                  COUNT=$((COUNT + 1))
                fi
              done
              if [ $COUNT -gt 0 ]; then
                # Enable spending in config (v4 councils have spending: false in git)
                sed -i 's/"spending": false/"spending": true/' "${DEST}/config.json"
                echo "✓ ${COUNCIL_ID}: restored spending-index.json + ${COUNT} monthly chunks"
                V4_RESTORED=$((V4_RESTORED + 1))
              else
                echo "⚠ ${COUNCIL_ID}: index found but no monthly chunks — needs bootstrap"
                rm -f "${DEST}/spending-index.json"
              fi
            else
              echo "⚠ ${COUNCIL_ID}: no spending data in previous deploy — run scripts/push_spending_data.sh to bootstrap"
            fi
          done
          echo "Restored v4 spending data for ${V4_RESTORED}/3 councils"

          # --- v3 year-chunked districts ---
          V3_COUNCILS="burnley:burnleycouncil hyndburn:hyndburncouncil pendle:pendlecouncil rossendale:rossendalecouncil lancaster:lancastercouncil ribble_valley:ribblevalleycouncil chorley:chorleycouncil south_ribble:southribblecouncil west_lancashire:westlancashirecouncil wyre:wyrecouncil preston:prestoncouncil fylde:fyldecouncil"
          V3_RESTORED=0
          for entry in $V3_COUNCILS; do
            COUNCIL_ID="${entry%%:*}"
            SLUG="${entry##*:}"
            DEST="burnley-council/data/${COUNCIL_ID}"
            SRC="${PREV_DEPLOY}/${SLUG}/data"
            if [ -f "${SRC}/spending-index.json" ]; then
              cp "${SRC}/spending-index.json" "${DEST}/spending-index.json"
              COUNT=0
              for f in "${SRC}"/spending-20??-??.json; do
                [ -f "$f" ] || continue
                cp "$f" "${DEST}/$(basename "$f")"
                COUNT=$((COUNT + 1))
              done
              if [ $COUNT -gt 0 ]; then
                echo "✓ ${COUNCIL_ID}: restored spending-index.json + ${COUNT} year chunks"
                V3_RESTORED=$((V3_RESTORED + 1))
              else
                echo "  ${COUNCIL_ID}: index only, no chunks — monolith fallback will be used"
                rm -f "${DEST}/spending-index.json"
              fi
            else
              echo "  ${COUNCIL_ID}: no chunks in previous deploy — monolith fallback will be used"
            fi
          done
          echo "Restored v3 spending data for ${V3_RESTORED}/12 councils"

          # Clean up
          rm -rf "$PREV_DEPLOY"

      # Council registry defined in job env.COUNCILS above. To add a council, edit it there.
      # Builds run sequentially — they share public/data/ so cannot run in parallel.
      - name: Build all councils
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}
          VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          for entry in $COUNCILS; do
            COUNCIL_ID="${entry%%:*}"
            COUNCIL_SLUG="${entry##*:}"
            echo "::group::Building ${COUNCIL_ID}"
            VITE_COUNCIL="${COUNCIL_ID}" VITE_BASE="/lancashire/${COUNCIL_SLUG}/" npx vite build --outDir "/tmp/lancashire-deploy/${COUNCIL_SLUG}"
            echo "::endgroup::"
          done

      # Remove spending.json monoliths and v3 year chunks from v4 councils to save deploy size.
      # The v4 worker loads from spending-index.json + monthly chunks, not spending.json.
      - name: Clean v4 council deploy artifacts
        run: |
          V4_SLUGS="lancashirecc blackpoolcouncil blackburncouncil"
          for SLUG in $V4_SLUGS; do
            DIR="/tmp/lancashire-deploy/${SLUG}/data"
            if [ -f "${DIR}/spending-index.json" ]; then
              # Remove monolith spending.json + compressed variants (v4 uses chunks instead)
              rm -f "${DIR}/spending.json" "${DIR}/spending.json.gz" "${DIR}/spending.json.br"
              # Remove v3 year chunks (spending-YYYY-YY.json where YY > 12)
              # and compressed monthly chunks (GitHub Pages doesn't serve .gz/.br)
              for f in "${DIR}"/spending-20??-??.json*; do
                BASE=$(basename "$f")
                # Extract last 2 digits before .json — year chunks have 13-99, months have 01-12
                SUFFIX=$(echo "$BASE" | sed 's/.*-\([0-9][0-9]\)\.json.*/\1/')
                if [ "$SUFFIX" -gt 12 ] 2>/dev/null; then
                  rm -f "$f"
                elif echo "$BASE" | grep -qE '\.(gz|br)$'; then
                  rm -f "$f"
                fi
              done
              echo "✓ Cleaned ${SLUG}: kept spending-index.json + monthly chunks only"
            fi
          done

      # Hub pages — root 404.html is the ONLY 404 GitHub Pages reads for SPA routing
      - name: Copy hub pages and generate sitemap
        run: |
          cp burnley-council/hub/index.html /tmp/lancashire-deploy/index.html
          cp burnley-council/hub/404.html /tmp/lancashire-deploy/404.html
          echo 'aidoge.co.uk' > /tmp/lancashire-deploy/CNAME
          cp public/robots.txt /tmp/lancashire-deploy/robots.txt
          # Generate sitemap index dynamically from council registry
          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
            for entry in $COUNCILS; do
              COUNCIL_SLUG="${entry##*:}"
              echo "  <sitemap><loc>https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/sitemap.xml</loc></sitemap>"
            done
            echo '</sitemapindex>'
          } > /tmp/lancashire-deploy/sitemap.xml

      - name: Deploy to GitHub Pages
        run: |
          npx gh-pages \
            -d /tmp/lancashire-deploy \
            --repo https://x-access-token:${{ secrets.DEPLOY_TOKEN }}@github.com/tompickup23/lancashire.git \
            --no-history \
            --user "AI DOGE Deploy <deploy@aidoge.co.uk>"

      # The root domain aidoge.co.uk is served by tompickup23.github.io (user pages).
      # The lancashire repo only serves /lancashire/* paths. Keep hub in sync.
      - name: Sync hub to tompickup23.github.io
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          cd /tmp
          git clone --depth 1 https://x-access-token:${DEPLOY_TOKEN}@github.com/tompickup23/tompickup23.github.io.git hub-repo
          cp /tmp/lancashire-deploy/index.html hub-repo/index.html
          cp /tmp/lancashire-deploy/404.html hub-repo/404.html
          cd hub-repo
          git config user.name "AI DOGE Deploy"
          git config user.email "deploy@aidoge.co.uk"
          if git diff --quiet; then
            echo "Hub pages unchanged — skipping"
          else
            git add index.html 404.html
            git commit -m "Sync hub pages from deploy"
            git push
            echo "✓ Hub pages synced to tompickup23.github.io"
          fi

      - name: Verify deployment
        if: success()
        run: |
          echo "Waiting 30s for GitHub Pages CDN propagation..."
          sleep 30
          FAIL=0
          # Check hub
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://aidoge.co.uk/")
          echo "https://aidoge.co.uk/ → HTTP ${CODE}"
          if [ "$CODE" != "200" ]; then FAIL=1; fi
          # Check each council
          for entry in $COUNCILS; do
            COUNCIL_SLUG="${entry##*:}"
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/")
            echo "https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/ → HTTP ${CODE}"
            if [ "$CODE" != "200" ]; then FAIL=1; fi
          done
          if [ "$FAIL" = "1" ]; then
            echo "Some pages returned non-200 — CDN may still be propagating (takes ~10 min)"
          else
            echo "All pages returned 200"
          fi
        continue-on-error: true
