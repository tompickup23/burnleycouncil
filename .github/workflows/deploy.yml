name: Build & Deploy Lancashire Councils

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'burnley-council/reports/**'
      - 'IMPROVEMENTS.md'
      - '.claude/**'
  workflow_dispatch:

concurrency:
  group: deploy-lancashire
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      COUNCILS: "burnley:burnleycouncil hyndburn:hyndburncouncil pendle:pendlecouncil rossendale:rossendalecouncil lancaster:lancastercouncil ribble_valley:ribblevalleycouncil chorley:chorleycouncil south_ribble:southribblecouncil lancashire_cc:lancashirecc blackpool:blackpoolcouncil west_lancashire:westlancashirecouncil blackburn:blackburncouncil wyre:wyrecouncil preston:prestoncouncil fylde:fyldecouncil"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Create deploy directory
        run: mkdir -p /tmp/lancashire-deploy

      # Council registry defined in job env.COUNCILS above. To add a council, edit it there.
      # Builds run sequentially — they share public/data/ so cannot run in parallel.
      - name: Build all councils
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}
        run: |
          for entry in $COUNCILS; do
            COUNCIL_ID="${entry%%:*}"
            COUNCIL_SLUG="${entry##*:}"
            echo "::group::Building ${COUNCIL_ID}"
            VITE_COUNCIL="${COUNCIL_ID}" VITE_BASE="/lancashire/${COUNCIL_SLUG}/" npx vite build --outDir "/tmp/lancashire-deploy/${COUNCIL_SLUG}"
            echo "::endgroup::"
          done

      # Hub pages — root 404.html is the ONLY 404 GitHub Pages reads for SPA routing
      - name: Copy hub pages and generate sitemap
        run: |
          cp burnley-council/hub/index.html /tmp/lancashire-deploy/index.html
          cp burnley-council/hub/404.html /tmp/lancashire-deploy/404.html
          echo 'aidoge.co.uk' > /tmp/lancashire-deploy/CNAME
          cp public/robots.txt /tmp/lancashire-deploy/robots.txt
          # Generate sitemap index dynamically from council registry
          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
            for entry in $COUNCILS; do
              COUNCIL_SLUG="${entry##*:}"
              echo "  <sitemap><loc>https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/sitemap.xml</loc></sitemap>"
            done
            echo '</sitemapindex>'
          } > /tmp/lancashire-deploy/sitemap.xml

      - name: Deploy to GitHub Pages
        run: |
          npx gh-pages \
            -d /tmp/lancashire-deploy \
            --repo https://x-access-token:${{ secrets.DEPLOY_TOKEN }}@github.com/tompickup23/lancashire.git \
            --no-history \
            --user "AI DOGE Deploy <deploy@aidoge.co.uk>"

      - name: Verify deployment
        if: success()
        run: |
          echo "Waiting 30s for GitHub Pages CDN propagation..."
          sleep 30
          FAIL=0
          # Check hub
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://aidoge.co.uk/")
          echo "https://aidoge.co.uk/ → HTTP ${CODE}"
          if [ "$CODE" != "200" ]; then FAIL=1; fi
          # Check each council
          for entry in $COUNCILS; do
            COUNCIL_SLUG="${entry##*:}"
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/")
            echo "https://aidoge.co.uk/lancashire/${COUNCIL_SLUG}/ → HTTP ${CODE}"
            if [ "$CODE" != "200" ]; then FAIL=1; fi
          done
          if [ "$FAIL" = "1" ]; then
            echo "Some pages returned non-200 — CDN may still be propagating (takes ~10 min)"
          else
            echo "All pages returned 200"
          fi
        continue-on-error: true
