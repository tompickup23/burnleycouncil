name: Build & Deploy Lancashire Councils

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'burnley-council/reports/**'
      - 'IMPROVEMENTS.md'
      - '.claude/**'
  workflow_dispatch:

concurrency:
  group: deploy-lancashire
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Create deploy directory
        run: mkdir -p /tmp/lancashire-deploy

      # Build each council sequentially — they share public/data/ so cannot run in parallel
      - name: Build Burnley
        run: VITE_COUNCIL=burnley VITE_BASE=/lancashire/burnleycouncil/ npx vite build --outDir /tmp/lancashire-deploy/burnleycouncil
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}

      - name: Build Hyndburn
        run: VITE_COUNCIL=hyndburn VITE_BASE=/lancashire/hyndburncouncil/ npx vite build --outDir /tmp/lancashire-deploy/hyndburncouncil
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}

      - name: Build Pendle
        run: VITE_COUNCIL=pendle VITE_BASE=/lancashire/pendlecouncil/ npx vite build --outDir /tmp/lancashire-deploy/pendlecouncil
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}

      - name: Build Rossendale
        run: VITE_COUNCIL=rossendale VITE_BASE=/lancashire/rossendalecouncil/ npx vite build --outDir /tmp/lancashire-deploy/rossendalecouncil
        env:
          VITE_CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}

      # Hub pages — root 404.html is the ONLY 404 GitHub Pages reads for SPA routing
      - name: Copy hub pages and static files
        run: |
          cp burnley-council/hub/index.html /tmp/lancashire-deploy/index.html
          cp burnley-council/hub/404.html /tmp/lancashire-deploy/404.html
          echo 'aidoge.co.uk' > /tmp/lancashire-deploy/CNAME
          cp public/robots.txt /tmp/lancashire-deploy/robots.txt

      - name: Deploy to GitHub Pages
        run: |
          npx gh-pages \
            -d /tmp/lancashire-deploy \
            --repo https://x-access-token:${{ secrets.DEPLOY_TOKEN }}@github.com/tompickup23/lancashire.git \
            --no-history \
            --user "AI DOGE Deploy <deploy@aidoge.co.uk>"

      - name: Verify deployment
        if: success()
        run: |
          echo "Waiting 30s for GitHub Pages CDN propagation..."
          sleep 30
          FAIL=0
          for path in "" "lancashire/burnleycouncil/" "lancashire/hyndburncouncil/" "lancashire/pendlecouncil/" "lancashire/rossendalecouncil/"; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://aidoge.co.uk/${path}")
            echo "https://aidoge.co.uk/${path} → HTTP ${CODE}"
            if [ "$CODE" != "200" ]; then FAIL=1; fi
          done
          if [ "$FAIL" = "1" ]; then
            echo "⚠️ Some pages returned non-200 — CDN may still be propagating (takes ~10 min)"
          else
            echo "✅ All pages returned 200"
          fi
        continue-on-error: true
