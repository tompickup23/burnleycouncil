# Daily System Audit â€” runs at 06:00 UTC, zero cost (GitHub Actions free tier)
# Checks data integrity, schema consistency, freshness, and known bugs.
# Commits audit report to burnley-council/reports/ and opens an issue if errors found.

name: Daily Audit

on:
  schedule:
    - cron: '0 6 * * *'  # 06:00 UTC daily
  workflow_dispatch:       # Manual trigger

permissions:
  contents: write
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git state checks

      - name: Setup Node (for build check)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run audit
        id: audit
        run: |
          python3 scripts/daily_audit.py --build 2>&1
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

          # Extract score for summary
          SCORE=$(grep -oP 'Health: \K\d+' burnley-council/reports/latest.md || echo "0")
          ERRORS=$(grep -oP 'Errors: \K\d+' burnley-council/reports/latest.md || echo "0")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Commit report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add burnley-council/reports/ || true
          if ! git diff --cached --quiet; then
            git commit -m "audit: $(date +%Y-%m-%d) â€” score ${{ steps.audit.outputs.score }}/100"
            git push
          fi

      - name: Open issue if errors
        if: steps.audit.outputs.errors != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('burnley-council/reports/latest.md', 'utf8');
            // Only show errors and warnings
            const lines = report.split('\n');
            const summary = lines.filter(l =>
              l.includes('ERROR') || l.includes('WARN') || l.startsWith('#') || l.startsWith('**')
            ).join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Audit Alert: ${new Date().toISOString().slice(0,10)} â€” ${${{ steps.audit.outputs.errors }}} errors`,
              body: `## Daily Audit Found Issues\n\n${summary}\n\n---\n*Auto-generated by daily-audit workflow*`,
              labels: ['audit', 'automated']
            });
