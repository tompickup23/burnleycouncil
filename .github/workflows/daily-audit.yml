# Daily System Audit — runs at 06:00 UTC, zero cost (GitHub Actions free tier)
# Checks data integrity, schema consistency, freshness, and known bugs.
# Commits audit report to burnley-council/reports/ and opens an issue if errors found.

name: Daily Audit

on:
  schedule:
    - cron: '0 6 * * *'  # 06:00 UTC daily
  workflow_dispatch:       # Manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Needed to commit audit reports to burnley-council/reports/
      issues: write     # Needed to create issues when errors found
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git state checks

      - name: Setup Node (for build check)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Audit npm dependencies
        run: npm audit --audit-level=moderate || true

      - name: Run audit
        id: audit
        run: |
          python3 scripts/daily_audit.py --build 2>&1
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

          # Extract score for summary
          SCORE=$(grep -oP 'Health: \K\d+' burnley-council/reports/latest.md || echo "0")
          ERRORS=$(grep -oP 'Errors: \K\d+' burnley-council/reports/latest.md || echo "0")
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Run improvement suggester
        run: python3 scripts/suggest_improvements.py 2>&1
        continue-on-error: true

      - name: Commit report
        env:
          AUDIT_SCORE: ${{ steps.audit.outputs.score }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add burnley-council/reports/ IMPROVEMENTS.md || true
          if ! git diff --cached --quiet; then
            git commit -m "audit: $(date +%Y-%m-%d) — score ${AUDIT_SCORE:-0}/100"
            # Only push to the current branch (never force-push or push to other branches)
            git push origin HEAD
          fi

      - name: Open issue if errors
        if: steps.audit.outputs.errors != '0'
        uses: actions/github-script@v7
        env:
          AUDIT_ERRORS: ${{ steps.audit.outputs.errors }}
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('burnley-council/reports/latest.md', 'utf8');
            // Only show errors and warnings
            const lines = report.split('\n');
            const summary = lines.filter(l =>
              l.includes('ERROR') || l.includes('WARN') || l.startsWith('#') || l.startsWith('**')
            ).join('\n');

            const errorCount = process.env.AUDIT_ERRORS || '0';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Audit Alert: ${new Date().toISOString().slice(0,10)} — ${errorCount} errors`,
              body: `## Daily Audit Found Issues\n\n${summary}\n\n---\n*Auto-generated by daily-audit workflow*`,
              labels: ['audit', 'automated']
            });
