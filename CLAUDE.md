# AI DOGE — Claude Code Project Guide

## What This Is

Multi-council public spending transparency platform for East Lancashire. React SPA deployed per-council via GitHub Pages at aidoge.co.uk.

**Live councils:** Burnley (30,580 txns, £355M), Hyndburn (29,804 txns, £211M), Pendle (49,741 txns, £125M), Rossendale (42,536 txns, £64M).

## Architecture

- **Frontend:** React 19 + Vite 7, lazy-loaded routes, config-driven per council
- **Data layer 1:** Council CSV spending data → `council_etl.py` → `spending.json`
- **Data layer 2:** GOV.UK MHCLG standardised budgets → `govuk_budgets.py` → `budgets_govuk.json`
- **Analysis:** `doge_analysis.py` — duplicates, split payments, CH compliance, Benford's Law, cross-council pricing
- **Hosting:** GitHub Pages (free), custom domain aidoge.co.uk
- **Servers:** Thurinus (Oracle x86, 1GB RAM, free), vps-main (Hostinger, 16GB RAM, £22/mo), 2x AWS t3.micro (free trial until Jul 2026)

## Key Build Commands

Builds MUST be sequential (shared `public/data/` causes race conditions):

```bash
# Deploy is AUTOMATIC — just push to main and deploy.yml handles everything.
# Manual commands below are for local testing only.

# Build single council for dev
VITE_COUNCIL=burnley VITE_BASE=/lancashire/burnleycouncil/ npx vite build

# Manual build all 4 councils (if CI/CD is down)
rm -rf /tmp/lancashire-deploy
VITE_COUNCIL=burnley VITE_BASE=/lancashire/burnleycouncil/ npx vite build --outDir /tmp/lancashire-deploy/burnleycouncil
VITE_COUNCIL=hyndburn VITE_BASE=/lancashire/hyndburncouncil/ npx vite build --outDir /tmp/lancashire-deploy/hyndburncouncil
VITE_COUNCIL=pendle VITE_BASE=/lancashire/pendlecouncil/ npx vite build --outDir /tmp/lancashire-deploy/pendlecouncil
VITE_COUNCIL=rossendale VITE_BASE=/lancashire/rossendalecouncil/ npx vite build --outDir /tmp/lancashire-deploy/rossendalecouncil

# Hub pages + CNAME (deploy.yml does this automatically)
cp burnley-council/hub/index.html /tmp/lancashire-deploy/index.html
cp burnley-council/hub/404.html /tmp/lancashire-deploy/404.html
echo 'aidoge.co.uk' > /tmp/lancashire-deploy/CNAME
cp public/robots.txt /tmp/lancashire-deploy/robots.txt

# Manual deploy (only if CI/CD is down)
npx gh-pages -d /tmp/lancashire-deploy --repo https://github.com/tompickup23/lancashire.git --no-history
```

## Key File Locations

### Frontend (React SPA)
| File | Purpose |
|------|---------|
| `src/App.jsx` | Router with 16 lazy-loaded routes |
| `src/pages/` | 32 page components (Spending, Budgets, DOGE, News, etc.) |
| `src/components/` | Shared UI components (Layout, ChartCard, StatCard, etc.) |
| `src/context/CouncilConfig.jsx` | Council-specific config context provider |
| `src/hooks/useData.js` | Data fetching hook (loads from /data/*.json) |
| `vite.config.js` | Build config with councilDataPlugin() for multi-council parameterisation |
| `index.html` | Template with %PLACEHOLDER% tokens replaced at build time |

### Data Pipeline (Python)
| File | Purpose |
|------|---------|
| `burnley-council/scripts/council_etl.py` | Main ETL: CSV → spending.json, CH enrichment, crime stats |
| `burnley-council/scripts/doge_analysis.py` | DOGE analysis: duplicates, splits, CH compliance, Benford's, cross-council |
| `burnley-council/scripts/govuk_budgets.py` | GOV.UK budget data fetch and parse |
| `burnley-council/scripts/govuk_trends.py` | Revenue trend analysis |
| `burnley-council/scripts/police_etl.py` | Police crime stats API |
| `burnley-council/scripts/build_council.sh` | Shell wrapper for building a specific council |

### Data Files (per council: `burnley-council/data/{council_id}/`)
| File | Generated By | Notes |
|------|-------------|-------|
| `spending.json` | council_etl.py | Core transaction data (15-40MB) |
| `config.json` | Manual | Controls features, branding, navigation |
| `doge_findings.json` | doge_analysis.py | Analysis findings for DOGE page |
| `doge_verification.json` | doge_analysis.py | Self-verification scores |
| `articles-index.json` | Manual/generated | Article listings |
| `foi_templates.json` | Manual per council | FOI request templates |
| `revenue_trends.json` | govuk_trends.py | GOV.UK revenue data |
| `supplier_profiles.json` | generate_supplier_profiles.py | Supplier deep dives |

### Shared Data (`burnley-council/data/shared/`)
| File | Purpose |
|------|---------|
| `legal_framework.json` | 12 UK council oversight laws |

## Critical Rules

1. **Never edit spending.json manually** — it's generated by council_etl.py
2. **Never edit doge_findings.json manually** — it's generated by doge_analysis.py
3. **Builds must be sequential** — the vite plugin copies data to shared `public/data/`
4. **config.json is the source of truth** for council features (what pages show in nav, etc.)
5. **Data in public/ is ephemeral** — copied from burnley-council/data/ at build time, gitignored
6. **No API keys in code** — use environment variables
7. **Clawdbot config lives on vps-main only** — at `/opt/clawdbot/` and `/root/clawd/`. No agent config files in this repo.
8. **supplier_profiles.json files are huge** (~400K lines each) — don't `git add` them without checking size first
9. **Don't commit .json data files casually** — spending.json, supplier_profiles.json, doge_findings.json etc. are large generated files. Only commit when data has actually changed.
10. **Test builds before committing** — `VITE_COUNCIL=burnley VITE_BASE=/ npx vite build` should exit 0

## SSH Hosts (configured in ~/.ssh/config)

| Alias | Host | User | Key |
|-------|------|------|-----|
| `vps-news` | 141.147.79.228 | ubuntu | ~/.ssh/vps-news.key |
| `vps-main` | 76.13.254.176 | root | ~/.ssh/id_ed25519 |
| `aws-1` | 51.20.51.127 | ubuntu | ~/.ssh/aws-1.pem |
| `aws-2` | 56.228.32.194 | ubuntu | ~/.ssh/aws-2.pem |

## How Multi-Council Works

`vite.config.js` contains `councilDataPlugin()` which:
1. Reads `VITE_COUNCIL` env var (burnley/hyndburn/pendle/rossendale)
2. Copies `burnley-council/data/{council}/` → `public/data/`
3. Copies `burnley-council/data/shared/` → `public/data/shared/`
4. Replaces `%PLACEHOLDER%` tokens in index.html with council-specific values from config.json
5. Sets `base` path from `VITE_BASE` env var

The React app is council-agnostic — it reads config.json at runtime and conditionally renders features.

## DOGE Analysis Pipeline

```
council_etl.py --council {id}    →  spending.json, taxonomy.json, insights.json
doge_analysis.py                 →  doge_findings.json, doge_verification.json (all councils)
```

Analysis checks: duplicate payments, split payment evasion, year-end spikes, round-number anomalies, Companies House compliance (temporal overlap), cross-council price gaps, Benford's Law forensic screening.

## Deployment

**Automated:** Push to `main` triggers `.github/workflows/deploy.yml` which builds all 4 councils and deploys to GitHub Pages. Zero AI tokens, zero cost.

- **Source repo:** tompickup23/burnleycouncil (this repo)
- **Deploy repo:** tompickup23/lancashire (gh-pages branch)
- **Hub repo:** tompickup23/tompickup23.github.io
- **Domain:** aidoge.co.uk → GitHub Pages with CNAME
- **CI/CD:** GitHub Actions (`deploy.yml`) — tests → build 4 councils → deploy → verify
- **Hub pages:** `burnley-council/hub/` — root 404.html handles SPA routing for all councils
- **Docs-only changes** (`.md` files, reports) do NOT trigger a rebuild

### DEPLOY_TOKEN Setup (one-time)
If the `DEPLOY_TOKEN` secret expires or needs rotating:
1. Create fine-grained PAT at https://github.com/settings/tokens?type=beta
2. Scope to `tompickup23/lancashire` repo, permission: Contents Read+Write
3. Add as secret at burnleycouncil repo → Settings → Secrets → Actions → `DEPLOY_TOKEN`

## Agent System

- **Gaius (Claude Code):** Heavy development, architecture, multi-file edits
- **Codex (OpenAI):** CLI dev agent, trial expires 2 Mar 2026
- **OpenCode:** CLI dev agent, free tier
- **Octavian (Clawdbot):** WhatsApp/Telegram bot on vps-main, uses Kimi K2.5 (free)
- **OpenAgents:** 3 agent processes on vps-main + Ollama (qwen2.5:7b)
- **clawd-worker:** AI DOGE data processing slave on vps-main

See [INFRASTRUCTURE.md](./INFRASTRUCTURE.md) for full server details, resource usage, and service inventory.

## Dev Server

```bash
VITE_COUNCIL=burnley VITE_BASE=/ npx vite
# Opens at http://localhost:5173
```

## Common Mistakes to Avoid

- **Don't create agent/bot config files in this repo** — Clawdbot lives on vps-main, not here
- **Don't assume Oracle VPS has lots of RAM** — vps-news is only 1GB RAM, memory-constrained
- **Don't run `git add .` or `git add -A`** — supplier_profiles.json files are 400K+ lines each
- **Don't edit generated JSON** — spending.json, doge_findings.json, doge_verification.json are all generated
- **Don't duplicate info across docs** — CLAUDE.md = dev guide, ARCHITECTURE.md = software, INFRASTRUCTURE.md = ops

## Cost: £22/month (Hostinger VPS — Clawdbot, email, clawd-worker). 2x AWS free trial ends Jul 2026.
